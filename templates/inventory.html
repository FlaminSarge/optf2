$def with (user, isvalve, items, views, filter_classes, sortby, baditems, stats, timestamps, filter_qualities, total_pages)
$ usern = user.get_persona()
$ profileurl = user.get_profile_url()
$ realn = user.get_real_name()
$var title: $project_name - $usern's Backpack
$ perma = "{0}user/{1}".format(virtual_root, user.get_id64())
$ rss = "{0}feed/{1}".format(virtual_root, user.get_id64())
$def insert_cell(item, user, sortby, invalid = False):
      $if not item:
          $ return '<div class="item_cell"></div>'
      $ item_id = item.get_id()
      $ item_link = "{0}item/{1}".format(virtual_root, item_id)
      $ quality = item.get_quality()["str"]
      $ equippedstr = ""
      $ quantity = item.get_quantity()
      $ equipped = (len(item.get_equipped_classes()) > 0)
      $if equipped:
          $ equippedstr = "Equipped "
      $if quantity > 1:
          $if not equipped:
              $ equippedstr += "{0}".format(quantity)
          $else:
              $ equippedstr += "({0})".format(quantity)
      $ cell_class = "item_cell"
      $if item.get_position() <= -1: $ cell_class += " undropped"
      <div class="$cell_class cell-${quality}" id="s${item_id}">
        <a class="item_link" href="$item_link">
          <img class="item_image_small" src="$item.optf2['image_url']" alt="$item.get_name()"/>
        </a>
        $if item.get_custom_name():
            <img src="${static_prefix}name_tag.png" class="icon-name" alt="Named"/>
        $if item.get_custom_description():
            <img src="${static_prefix}desc_tag.png" class="icon-desc"  alt="Described"/>
        $if "gift_from" in item.optf2:
            <img src="${static_prefix}gift_icon.png" class="icon-gift"  alt="Gift"/>
        $if "color" in item.optf2:
            <span class="paint_splotch" style="background: $item.optf2['color'];">&nbsp;</span>
        $if equippedstr:
            <span class="equipped">$equippedstr</span>
        <div class="item_attribs">
          $:item.optf2["cell_name"]
          $ painty = item.optf2.get("painted_text", "")
          <div class="item-level">Level $item.optf2["level"] $:painty $item.optf2["type"]</div>
          $if item.optf2["description"]:
              <div class="item-description">
                $item.optf2["description"]
              </div>
          $for attr in item.optf2["attrs"]:
              <div class="attr-${attr.get_type()}">
                $if "gift_content" in item.optf2 and attr.get_name() == "referenced item def":
                    Contains <span class="prefix-${item.optf2['gift_quality']}">$item.optf2["gift_content"]</span>
                $else:
                    $:attr.get_description_formatted().replace("\n", "<br/>")
              </div>
          $if item.is_untradable():
              <div class="attr-neutral">
                Untradable
              </div>
        </div>
      </div>
<div id="header" style="position: relative;">
  <div class="toolbar" style="width: 1080px; margin: 0 auto 15px auto;">
  $ cgame = user.get_current_game()
  $ cstatus = user.get_status()
  $ name_suffix = ""
  $if isvalve:
      $ name_suffix = '<img src="{0}valve.png" alt="Valve" title="Valve Employee"/>'.format(static_prefix)
  $if user.get_visibility() != "public":
      $ name_suffix += '<span class="attr-negative" style="font-weight: normal;"> (private)</span>'
    <div class="tool" style="padding-right: 0; border: 0;">
      <a href="$profileurl">
        <img src="$user.get_avatar_url(user.AVATAR_SMALL)" alt="$realn" title="$realn"/>
      </a>
    </div>
    <div class="tool" style="padding-left: 5px;">
      <b><a href="$profileurl">$usern</a> $:name_suffix</b>
      <div id="status_$cstatus">
        $if cgame:
            Playing \
            $ game_extra = cgame.get("extra", "Unknown")
            $ game_extra_title = game_extra
            $if len(game_extra) >= 20:
                $ game_extra = game_extra[:17] + "..."
            $ game_server = cgame.get("server", "0.0.0.0:0")
            $if cgame.has_key("id"):
                <a href="http://store.steampowered.com/app/$cgame['id']" title="$game_extra_title">$game_extra</a>
            $else:
                $game_extra
            $if game_server != "0.0.0.0:0":
                <a href="steam://connect/$game_server">(Connect)</a>
        $else:
            $cstatus
      </div>
    </div>
    <div class="tool">
      $views
      $if views == 1:
          view
      $else:
          views
      <br/>
      $stats["weapons"] weapons | $stats["hats"] hats | $stats["misc"] misc ($stats["total"] total)
    </div>
    <div id="option-controls" class="tool" style="border-right: 0;">
      <div class="dropdown-menu">
        <b>Sort</b>
        <ul>
          <li><a href="$qurl(sort = None)">Default</a></li>
          <li><a href="$qurl(sort = 'time')">Time</a></li>
          <li><a href="$qurl(sort = 'serial')">Serial</a></li>
          <li><a href="$qurl(sort = 'level')">Level</a></li>
          <li><a href="$qurl(sort = 'name')">Name</a></li>
          <li><a href="$qurl(sort = 'slot')">Type</a></li>
          <li><a href="$qurl(sort = 'class')">Class</a></li>
        </ul>
      </div>
      <div class="dropdown-menu">
        <b>Class</b>
        <ul>
          <li><a href="$qurl(sortclass = None)"><img src="${static_prefix}tf_icon.png" alt="All" title="All"/> All</a></li>
          $for k in filter_classes:
              <li>
                <a href="$qurl(sortclass = k)">
                  <img src="${static_prefix}${k}_icon.png" alt="${k}" title="${k}"/> $k
                </a>
              </li>
        </ul>
      </div>
      <div class="dropdown-menu">
        <b>Quality</b>
        <ul>
          <li><a href="$qurl(quality = None)">All</a></li>
          $for q in filter_qualities:
              <li><a href="$qurl(quality = q['id'])"><span class="prefix-${q['str']}">$q["prettystr"]</span></a></li>
        </ul>
      </div>
      <div class="dropdown-menu">
        <b>Timeline</b>
        <ul style="min-width: 170px;">
          <li><a href="$qurl(time = None)">Now</a></li>
          $for ts in timestamps:
              <li><a href="$qurl(time = ts[0])">$ts[1]</a></li>
        </ul>
      </div>
    </div>
    <div class="tool" style="float: right; border-right: none;">
      <a href="$rss">
        <img src="${static_prefix}feed_icon.png" alt="RSS" title="Subscribe to an RSS feed of this backpack"/>
      </a>
    </div>
  </div>
</div>
<div id="content">
  $if len(items) <= 0 and len(baditems) <= 0:
      <h2>Empty!</h2>
  <div id="backpack" style="width: 1040px;">
    $if len(baditems) > 0:
        <div id="page-0" class="backpack-page">
          $for item in baditems:
              $:insert_cell(item, user, sortby, invalid = True)
        </div>
    $for p in total_pages:
        <div id="page-${p}" class="backpack-page">
          $ slice = p * 50
          $for item in items[slice - 50:slice]:
              $:insert_cell(item, user, sortby)
        </div>
  </div>
</div>
<div id="footer">
  $project_name uses the <a href="http://steampowered.com">Steam API</a>
</div>
